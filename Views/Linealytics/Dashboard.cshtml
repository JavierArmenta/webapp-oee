@{
    ViewData["Title"] = "Dashboard - Linealytics";
}

<div class="container-fluid">
    <div class="card shadow-sm mt-3">
        <div class="card-body">
            <h1 class="h3 mb-0">
                <i class="bi bi-speedometer2 me-2"></i>Dashboard - Linealytics
            </h1>
        </div>
    </div>

    <!-- Select with search -->
    <div class="card mt-3">
        <div class="card-header">
            <h5 class="mb-0">Filtros</h5>
        </div>

        <div class="card-body">
            <div class="row">
                <div class="col-lg-4">
                    <label class="form-label">Área</label>
                    <select class="form-control select" id="select-area">
                        <option value="">Todas las áreas</option>
                        @foreach (var area in (List<WebApp.Models.Area>)ViewBag.Areas)
                        {
                            <option value="@area.Id">@area.Nombre</option>
                        }
                    </select>
                </div>

                <div class="col-lg-4">
                    <label class="form-label">Línea</label>
                    <select class="form-control select" id="select-linea" disabled>
                        <option value="">Seleccione un área primero</option>
                        @foreach (var linea in (List<WebApp.Models.Linea>)ViewBag.Lineas)
                        {
                            <option value="@linea.Id" data-area="@linea.AreaId">@linea.Nombre</option>
                        }
                    </select>
                </div>

                <div class="col-lg-4">
                    <label class="form-label">Máquina</label>
                    <select class="form-control select" id="select-maquina" disabled>
                        <option value="">Seleccione un área primero</option>
                        @foreach (var maquina in (List<WebApp.Models.Maquina>)ViewBag.Maquinas)
                        {
                            <option value="@maquina.Id" data-linea="@maquina.Estacion.LineaId" data-area="@maquina.Estacion.Linea.AreaId">
                                @maquina.Nombre
                            </option>
                        }
                    </select>
                </div>
            </div>
        </div>
    </div>
    <!-- /select with search -->

    <!-- Stacked column chart -->
    <div class="card mt-3">
        <div class="card-header">
            <h5 class="mb-0">Stacked column chart</h5>
        </div>

        <div class="card-body">
            <p class="mb-3">Stacked <code>column</code> charts present the information in the same sequence on each bar. The stacked bar chart stacks bars that represent different groups on top of each other. The height of the resulting bar shows the combined result of the groups. However, stacked bar charts are not suited to datasets where some groups have negative values. In such cases, grouped bar charts are preferable.</p>

            <div class="chart-container">
                <div class="chart" id="google-bar-stacked"></div>
            </div>
        </div>
    </div>
    <!-- /stacked column chart -->
</div>

@section Scripts {
        <script src="~/assets/js/jquery/jquery.min.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="~/assets/js/vendor/forms/selects/select2.min.js"></script>


    <script>
        var GoogleBarStacked = function() {

            //
            // Setup module components
            //

            // Stacked bar chart
            var _googleBarStacked = function() {
                if (typeof google == 'undefined') {
                    console.warn('Warning - Google Charts library is not loaded.');
                    return;
                }

                // Switch colors in dark and light themes
                function color_theme(darkColor, lightColor) {
                    return document.documentElement.getAttribute('data-color-theme') == 'dark' ? darkColor : lightColor
                }

                // Initialize chart
                google.charts.load('current', {
                    callback: function () {

                        // Draw chart
                        drawBarStacked();

                        // Resize on sidebar width change
                        var sidebarToggle = document.querySelectorAll('.sidebar-control');
                        if (sidebarToggle) {
                            sidebarToggle.forEach(function(togglers) {
                                togglers.addEventListener('click', drawBarStacked);
                            });
                        }

                        // Resize on window resize
                        var resizeBarStacked;
                        window.addEventListener('resize', function() {
                            clearTimeout(resizeBarStacked);
                            resizeBarStacked = setTimeout(function () {
                                drawBarStacked();
                            }, 200);
                        });

                        // Redraw chart when color theme is changed
                        document.querySelectorAll('[name="main-theme"]').forEach(function(radio) {
                            radio.addEventListener('change', drawBarStacked);
                        });
                    },
                    packages: ['corechart']
                });

                // Chart settings
                function drawBarStacked() {

                    // Define charts element
                    var bar_stacked_element = document.getElementById('google-bar-stacked');

                    // Data
                    var data = google.visualization.arrayToDataTable([
                        ['Genre', 'Fantasy & Sci Fi', 'Romance', 'Mystery/Crime', 'General', 'Western', 'Literature', { role: 'annotation' } ],
                        ['2000', 20, 30, 35, 40, 45, 30, ''],
                        ['2005', 14, 20, 25, 30, 48, 30, ''],
                        ['2010', 10, 24, 20, 32, 18, 5, ''],
                        ['2015', 15, 25, 30, 35, 20, 15, ''],
                        ['2020', 16, 22, 23, 30, 16, 9, ''],
                        ['2025', 12, 26, 20, 40, 20, 30, ''],
                        ['2030', 28, 19, 29, 30, 12, 13, '']
                    ]);

                    // Options
                    var options_bar_stacked = {
                        fontName: 'var(--body-font-family)',
                        height: 400,
                        fontSize: 12,
                        backgroundColor: 'transparent',
                        chartArea: {
                            left: '3%',
                            width: '95%',
                            height: 350
                        },
                        isStacked: true,
                        tooltip: {
                            textStyle: {
                                fontSize: 14
                            }
                        },
                        vAxis: {
                            textStyle: {
                                color: color_theme('#fff', '#333')
                            }
                        },
                        hAxis: {
                            baselineColor: color_theme('#6e6f71', '#9CA3AF'),
                            textStyle: {
                                color: color_theme('#fff', '#333')
                            },
                            gridlines:{
                                color: color_theme('#4d4d51', '#E5E7EB'),
                                count: 10
                            },
                            minorGridlines: {
                                color: color_theme('#3f4044', '#F3F4F6')
                            },
                            minValue: 0
                        },
                        legend: {
                            position: 'top',
                            alignment: 'center',
                            textStyle: {
                                color: color_theme('#fff', '#333')
                            }
                        },
                        series: {
                            0: { color: '#2ec7c9' },
                            1: { color: '#b6a2de' },
                            2: { color: '#5ab1ef' },
                            3: { color: '#ffb980' },
                            4: { color: '#d87a80' },
                            5: { color: '#8d98b3' }
                        }
                    };

                    // Draw chart
                    var bar_stacked = new google.visualization.BarChart(bar_stacked_element);
                    bar_stacked.draw(data, options_bar_stacked);
                }

            };

            //
            // Return objects assigned to module
            //

            return {
                init: function() {
                    _googleBarStacked();
                }
            }
        }();

        // Initialize module
        // ------------------------------

        GoogleBarStacked.init();

        // Select2 Initialization
        // ------------------------------
        var Select2Filters = function() {

            // Guardar todas las opciones originales
            var todasLineas = [];
            var todasMaquinas = [];

            var _componentSelect2 = function() {
                if (!$().select2) {
                    console.warn('Warning - select2.min.js is not loaded.');
                    return;
                }

                // Guardar todas las opciones al inicio
                $('#select-linea option').each(function() {
                    if ($(this).val() !== '') {
                        todasLineas.push({
                            value: $(this).val(),
                            text: $(this).text(),
                            area: $(this).data('area')
                        });
                    }
                });

                $('#select-maquina option').each(function() {
                    if ($(this).val() !== '') {
                        todasMaquinas.push({
                            value: $(this).val(),
                            text: $(this).text(),
                            linea: $(this).data('linea'),
                            area: $(this).data('area')
                        });
                    }
                });

                // Initialize all selects with Select2
                $('.select').select2({
                    placeholder: 'Seleccionar...',
                    allowClear: true
                });

                // Filtros en cascada
                $('#select-area').on('change', function() {
                    var areaId = $(this).val();

                    if (!areaId) {
                        // Si no hay área seleccionada, deshabilitar líneas y máquinas
                        $('#select-linea').prop('disabled', true);
                        $('#select-maquina').prop('disabled', true);

                        $('#select-linea').empty().append('<option value="">Seleccione un área primero</option>');
                        $('#select-maquina').empty().append('<option value="">Seleccione un área primero</option>');

                        $('#select-linea').val('').trigger('change');
                        $('#select-maquina').val('').trigger('change');
                    } else {
                        // Habilitar select de líneas
                        $('#select-linea').prop('disabled', false);

                        // Filtrar y reconstruir líneas
                        $('#select-linea').empty().append('<option value="">Todas las líneas</option>');

                        todasLineas.filter(function(linea) {
                            return linea.area == areaId;
                        }).forEach(function(linea) {
                            $('#select-linea').append(
                                $('<option></option>')
                                    .attr('value', linea.value)
                                    .attr('data-area', linea.area)
                                    .text(linea.text)
                            );
                        });

                        // Habilitar select de máquinas
                        $('#select-maquina').prop('disabled', false);

                        // Filtrar y reconstruir máquinas por área
                        $('#select-maquina').empty().append('<option value="">Todas las máquinas</option>');

                        todasMaquinas.filter(function(maquina) {
                            return maquina.area == areaId;
                        }).forEach(function(maquina) {
                            $('#select-maquina').append(
                                $('<option></option>')
                                    .attr('value', maquina.value)
                                    .attr('data-linea', maquina.linea)
                                    .attr('data-area', maquina.area)
                                    .text(maquina.text)
                            );
                        });

                        // Reset selects dependientes
                        $('#select-linea').val('').trigger('change');
                        $('#select-maquina').val('').trigger('change');
                    }
                });

                $('#select-linea').on('change', function() {
                    var lineaId = $(this).val();
                    var areaId = $('#select-area').val();

                    // Filtrar y reconstruir máquinas
                    $('#select-maquina').empty().append('<option value="">Todas las máquinas</option>');

                    var maquinasFiltradas = todasMaquinas;

                    // Filtrar por área si está seleccionada
                    if (areaId) {
                        maquinasFiltradas = maquinasFiltradas.filter(function(maquina) {
                            return maquina.area == areaId;
                        });
                    }

                    // Filtrar por línea si está seleccionada
                    if (lineaId) {
                        maquinasFiltradas = maquinasFiltradas.filter(function(maquina) {
                            return maquina.linea == lineaId;
                        });
                    }

                    // Agregar opciones filtradas
                    maquinasFiltradas.forEach(function(maquina) {
                        $('#select-maquina').append(
                            $('<option></option>')
                                .attr('value', maquina.value)
                                .attr('data-linea', maquina.linea)
                                .attr('data-area', maquina.area)
                                .text(maquina.text)
                        );
                    });

                    // Reset select de máquinas
                    $('#select-maquina').val('').trigger('change');
                });

                // Evento cuando cambia cualquier filtro - actualizar gráfica
                $('.select').on('change', function() {
                    console.log('Filtro cambiado:', {
                        area: $('#select-area').val(),
                        linea: $('#select-linea').val(),
                        maquina: $('#select-maquina').val()
                    });
                    // Aquí puedes llamar a una función para recargar la gráfica con los filtros
                    // updateChart();
                });
            };

            return {
                init: function() {
                    _componentSelect2();
                }
            }
        }();

        // Initialize Select2
        document.addEventListener('DOMContentLoaded', function() {
            Select2Filters.init();
        });
    </script>
}
