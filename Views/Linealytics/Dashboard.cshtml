@{
    ViewData["Title"] = "Dashboard - Linealytics";
}

<div class="container-fluid">
    <div class="card shadow-sm mt-3">
        <div class="card-body">
            <h1 class="h3 mb-0">
                <i class="bi bi-speedometer2 me-2"></i>Dashboard - Linealytics
            </h1>
        </div>
    </div>

    <!-- Select with search -->
    <div class="card mt-3">
        <div class="card-header">
            <h5 class="mb-0">Filtros</h5>
        </div>

        <div class="card-body">
            <div class="row">
                <div class="col-lg-3">
                    <label class="form-label">Área</label>
                    <select class="form-control select" id="select-area">
                        <option value="">Todas las áreas</option>
                        @foreach (var area in (List<WebApp.Models.Area>)ViewBag.Areas)
                        {
                            <option value="@area.Id">@area.Nombre</option>
                        }
                    </select>
                </div>

                <div class="col-lg-3">
                    <label class="form-label">Línea</label>
                    <select class="form-control select" id="select-linea" disabled>
                        <option value="">Seleccione un área primero</option>
                        @foreach (var linea in (List<WebApp.Models.Linea>)ViewBag.Lineas)
                        {
                            <option value="@linea.Id" data-area="@linea.AreaId">@linea.Nombre</option>
                        }
                    </select>
                </div>

                <div class="col-lg-3">
                    <label class="form-label">Estación</label>
                    <select class="form-control select" id="select-estacion" disabled>
                        <option value="">Seleccione una línea primero</option>
                        @foreach (var estacion in (List<WebApp.Models.Estacion>)ViewBag.Estaciones)
                        {
                            <option value="@estacion.Id" data-linea="@estacion.LineaId" data-area="@estacion.Linea.AreaId">
                                @estacion.Nombre
                            </option>
                        }
                    </select>
                </div>

                <div class="col-lg-3">
                    <label class="form-label">Máquina</label>
                    <select class="form-control select" id="select-maquina" disabled>
                        <option value="">Seleccione una estación primero</option>
                        @foreach (var maquina in (List<WebApp.Models.Maquina>)ViewBag.Maquinas)
                        {
                            <option value="@maquina.Id" data-estacion="@maquina.EstacionId" data-linea="@maquina.Estacion.LineaId" data-area="@maquina.Estacion.Linea.AreaId">
                                @maquina.Nombre
                            </option>
                        }
                    </select>
                </div>
            </div>
        </div>
    </div>
    <!-- /select with search -->


    <!-- ECharts Timeline chart -->
    <div class="card mt-3">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-clock-history me-2"></i>Timeline de Paros por Máquina (Últimos 7 días)
            </h5>
        </div>

        <div class="card-body">
            <p class="mb-3">Timeline que muestra cada paro registrado con su fecha y hora de inicio y fin. Cada segmento representa un paro individual, donde el eje Y muestra las máquinas y el eje X muestra el tiempo. Los colores indican los departamentos operadores responsables.</p>
            <div class="chart-container">
                <div class="chart has-fixed-height" id="bars_stacked"></div>
            </div>
        </div>
    </div>
    <!-- /timeline chart -->

</div>

@section Scripts {
        <script src="~/assets/js/jquery/jquery.min.js"></script>
    <script src="~/assets/js/vendor/visualization/echarts/echarts.min.js"></script>
    <script src="~/assets/js/vendor/forms/selects/select2.min.js"></script>


    <script>

        // Select2 Initialization
        // ------------------------------
        var Select2Filters = function() {

            // Guardar todas las opciones originales
            var todasLineas = [];
            var todasEstaciones = [];
            var todasMaquinas = [];

            var _componentSelect2 = function() {
                if (!$().select2) {
                    console.warn('Warning - select2.min.js is not loaded.');
                    return;
                }

                // Guardar todas las opciones al inicio
                $('#select-linea option').each(function() {
                    if ($(this).val() !== '') {
                        todasLineas.push({
                            value: $(this).val(),
                            text: $(this).text(),
                            area: $(this).data('area')
                        });
                    }
                });

                $('#select-estacion option').each(function() {
                    if ($(this).val() !== '') {
                        todasEstaciones.push({
                            value: $(this).val(),
                            text: $(this).text(),
                            linea: $(this).data('linea'),
                            area: $(this).data('area')
                        });
                    }
                });

                $('#select-maquina option').each(function() {
                    if ($(this).val() !== '') {
                        todasMaquinas.push({
                            value: $(this).val(),
                            text: $(this).text(),
                            estacion: $(this).data('estacion'),
                            linea: $(this).data('linea'),
                            area: $(this).data('area')
                        });
                    }
                });

                // Initialize all selects with Select2
                $('.select').select2({
                    placeholder: 'Seleccionar...',
                    allowClear: true
                });

                // Filtros en cascada
                $('#select-area').on('change', function() {
                    var areaId = $(this).val();

                    if (!areaId) {
                        // Si no hay área seleccionada, deshabilitar líneas, estaciones y máquinas
                        $('#select-linea').prop('disabled', true);
                        $('#select-estacion').prop('disabled', true);
                        $('#select-maquina').prop('disabled', true);

                        $('#select-linea').empty().append('<option value="">Seleccione un área primero</option>');
                        $('#select-estacion').empty().append('<option value="">Seleccione un área primero</option>');
                        $('#select-maquina').empty().append('<option value="">Seleccione un área primero</option>');

                        $('#select-linea').val('').trigger('change');
                        $('#select-estacion').val('').trigger('change');
                        $('#select-maquina').val('').trigger('change');
                    } else {
                        // Habilitar select de líneas
                        $('#select-linea').prop('disabled', false);

                        // Filtrar y reconstruir líneas
                        $('#select-linea').empty().append('<option value="">Todas las líneas</option>');

                        todasLineas.filter(function(linea) {
                            return linea.area == areaId;
                        }).forEach(function(linea) {
                            $('#select-linea').append(
                                $('<option></option>')
                                    .attr('value', linea.value)
                                    .attr('data-area', linea.area)
                                    .text(linea.text)
                            );
                        });

                        // Filtrar y reconstruir estaciones por área
                        $('#select-estacion').empty().append('<option value="">Todas las estaciones</option>');

                        todasEstaciones.filter(function(estacion) {
                            return estacion.area == areaId;
                        }).forEach(function(estacion) {
                            $('#select-estacion').append(
                                $('<option></option>')
                                    .attr('value', estacion.value)
                                    .attr('data-linea', estacion.linea)
                                    .attr('data-area', estacion.area)
                                    .text(estacion.text)
                            );
                        });

                        // Habilitar select de estaciones
                        $('#select-estacion').prop('disabled', false);

                        // Filtrar y reconstruir máquinas por área
                        $('#select-maquina').empty().append('<option value="">Todas las máquinas</option>');

                        todasMaquinas.filter(function(maquina) {
                            return maquina.area == areaId;
                        }).forEach(function(maquina) {
                            $('#select-maquina').append(
                                $('<option></option>')
                                    .attr('value', maquina.value)
                                    .attr('data-estacion', maquina.estacion)
                                    .attr('data-linea', maquina.linea)
                                    .attr('data-area', maquina.area)
                                    .text(maquina.text)
                            );
                        });

                        // Habilitar select de máquinas
                        $('#select-maquina').prop('disabled', false);

                        // Reset selects dependientes
                        $('#select-linea').val('').trigger('change');
                        $('#select-estacion').val('').trigger('change');
                        $('#select-maquina').val('').trigger('change');
                    }
                });

                $('#select-linea').on('change', function() {
                    var lineaId = $(this).val();
                    var areaId = $('#select-area').val();

                    // Filtrar y reconstruir estaciones
                    $('#select-estacion').empty().append('<option value="">Todas las estaciones</option>');

                    var estacionesFiltradas = todasEstaciones;

                    // Filtrar por área si está seleccionada
                    if (areaId) {
                        estacionesFiltradas = estacionesFiltradas.filter(function(estacion) {
                            return estacion.area == areaId;
                        });
                    }

                    // Filtrar por línea si está seleccionada
                    if (lineaId) {
                        estacionesFiltradas = estacionesFiltradas.filter(function(estacion) {
                            return estacion.linea == lineaId;
                        });
                    }

                    // Agregar opciones filtradas de estaciones
                    estacionesFiltradas.forEach(function(estacion) {
                        $('#select-estacion').append(
                            $('<option></option>')
                                .attr('value', estacion.value)
                                .attr('data-linea', estacion.linea)
                                .attr('data-area', estacion.area)
                                .text(estacion.text)
                        );
                    });

                    // Filtrar y reconstruir máquinas
                    $('#select-maquina').empty().append('<option value="">Todas las máquinas</option>');

                    var maquinasFiltradas = todasMaquinas;

                    // Filtrar por área si está seleccionada
                    if (areaId) {
                        maquinasFiltradas = maquinasFiltradas.filter(function(maquina) {
                            return maquina.area == areaId;
                        });
                    }

                    // Filtrar por línea si está seleccionada
                    if (lineaId) {
                        maquinasFiltradas = maquinasFiltradas.filter(function(maquina) {
                            return maquina.linea == lineaId;
                        });
                    }

                    // Agregar opciones filtradas de máquinas
                    maquinasFiltradas.forEach(function(maquina) {
                        $('#select-maquina').append(
                            $('<option></option>')
                                .attr('value', maquina.value)
                                .attr('data-estacion', maquina.estacion)
                                .attr('data-linea', maquina.linea)
                                .attr('data-area', maquina.area)
                                .text(maquina.text)
                        );
                    });

                    // Reset selects de estaciones y máquinas
                    $('#select-estacion').val('').trigger('change');
                    $('#select-maquina').val('').trigger('change');
                });

                $('#select-estacion').on('change', function() {
                    var estacionId = $(this).val();
                    var lineaId = $('#select-linea').val();
                    var areaId = $('#select-area').val();

                    // Filtrar y reconstruir máquinas
                    $('#select-maquina').empty().append('<option value="">Todas las máquinas</option>');

                    var maquinasFiltradas = todasMaquinas;

                    // Filtrar por área si está seleccionada
                    if (areaId) {
                        maquinasFiltradas = maquinasFiltradas.filter(function(maquina) {
                            return maquina.area == areaId;
                        });
                    }

                    // Filtrar por línea si está seleccionada
                    if (lineaId) {
                        maquinasFiltradas = maquinasFiltradas.filter(function(maquina) {
                            return maquina.linea == lineaId;
                        });
                    }

                    // Filtrar por estación si está seleccionada
                    if (estacionId) {
                        maquinasFiltradas = maquinasFiltradas.filter(function(maquina) {
                            return maquina.estacion == estacionId;
                        });
                    }

                    // Agregar opciones filtradas
                    maquinasFiltradas.forEach(function(maquina) {
                        $('#select-maquina').append(
                            $('<option></option>')
                                .attr('value', maquina.value)
                                .attr('data-estacion', maquina.estacion)
                                .attr('data-linea', maquina.linea)
                                .attr('data-area', maquina.area)
                                .text(maquina.text)
                        );
                    });

                    // Reset select de máquinas
                    $('#select-maquina').val('').trigger('change');
                });

                // Evento cuando cambia cualquier filtro - actualizar gráfica
                $('.select').on('change', function() {
                    var areaId = $('#select-area').val();
                    var lineaId = $('#select-linea').val();
                    var estacionId = $('#select-estacion').val();
                    var maquinaId = $('#select-maquina').val();

                    console.log('Filtro cambiado:', {
                        area: areaId,
                        linea: lineaId,
                        estacion: estacionId,
                        maquina: maquinaId
                    });

                    // Si hay área seleccionada, actualizar la gráfica
                    if (areaId) {
                        EchartsBarsStackedLight.update(areaId, lineaId || null, estacionId || null, maquinaId || null);
                    }
                });
            };

            return {
                init: function() {
                    _componentSelect2();
                }
            }
        }();

        // Initialize Select2
        document.addEventListener('DOMContentLoaded', function() {
            Select2Filters.init();
        });

        // ECharts Stacked Bars
        // ------------------------------
        var EchartsBarsStackedLight = function() {

            var chartInstance = null;

            // Stacked bar chart
            var _barsStackedLightExample = function() {
                if (typeof echarts == 'undefined') {
                    console.warn('Warning - echarts.min.js is not loaded.');
                    return;
                }

                // Define element
                var bars_stacked_element = document.getElementById('bars_stacked');

                // Charts configuration
                if (bars_stacked_element) {

                    // Initialize chart
                    var bars_stacked = echarts.init(bars_stacked_element, null, { renderer: 'svg' });
                    chartInstance = bars_stacked;

                    // Draw chart with empty data
                    drawBarsStacked(null);

                    // Resize handlers
                    var triggerChartResize = function() {
                        bars_stacked_element && bars_stacked.resize();
                    };

                    // On sidebar width change
                    var sidebarToggle = document.querySelectorAll('.sidebar-control');
                    if (sidebarToggle) {
                        sidebarToggle.forEach(function(togglers) {
                            togglers.addEventListener('click', triggerChartResize);
                        });
                    }

                    // On window resize
                    var resizeCharts;
                    window.addEventListener('resize', function() {
                        clearTimeout(resizeCharts);
                        resizeCharts = setTimeout(function () {
                            triggerChartResize();
                        }, 200);
                    });
                }
            };

            // Chart settings
            function drawBarsStacked(datosParos) {
                if (!chartInstance) return;

                var legendData = [];
                var yAxisData = [];
                var series = [];
                var xAxisMin = null;
                var xAxisMax = null;

                if (!datosParos || !datosParos.maquinas || datosParos.maquinas.length === 0) {
                    // Datos de ejemplo si no hay datos
                    legendData = ['Sin datos'];
                    yAxisData = ['Selecciona un área'];
                    series = [{
                        name: 'Sin datos',
                        type: 'bar',
                        barWidth: 36,
                        itemStyle: {
                            color: '#ccc',
                            barBorderRadius: [4, 4, 4, 4]
                        },
                        data: []
                    }];
                    xAxisMin = new Date().getTime();
                    xAxisMax = new Date().getTime() + 3600000;
                } else {
                    // Construir leyenda con departamentos
                    legendData = datosParos.departamentos.map(function(d) {
                        return d.departamento;
                    });

                    // Usar las máquinas como eje Y
                    yAxisData = datosParos.maquinas.map(function(m) {
                        return m.nombre;
                    });

                    // Configurar rango de fechas para el eje X (timeline)
                    xAxisMin = new Date(datosParos.fechaMin).getTime();
                    xAxisMax = new Date(datosParos.fechaMax).getTime();

                    // Primero, crear serie de producción (espacios sin paros) - verde
                    var dataProduccion = [];
                    datosParos.maquinas.forEach(function(maquina, maqIndex) {
                        // Obtener todos los paros de esta máquina, ordenados por fecha
                        var parosMaquina = datosParos.datos
                            .filter(function(d) { return d.maquinaId === maquina.id; })
                            .map(function(p) {
                                return {
                                    inicio: new Date(p.fechaInicio).getTime(),
                                    fin: p.fechaFin ? new Date(p.fechaFin).getTime() : new Date(p.fechaInicio).getTime()
                                };
                            })
                            .sort(function(a, b) { return a.inicio - b.inicio; });

                        // Si no hay paros, todo el período es producción
                        if (parosMaquina.length === 0) {
                            dataProduccion.push({
                                name: maquina.nombre,
                                value: [maqIndex, xAxisMin, xAxisMax],
                                itemStyle: { color: '#66bb6a', borderRadius: 4 },
                                tipo: 'Producción',
                                maquina: maquina.nombre
                            });
                        } else {
                            // Producción desde el inicio hasta el primer paro
                            if (parosMaquina[0].inicio > xAxisMin) {
                                dataProduccion.push({
                                    name: maquina.nombre,
                                    value: [maqIndex, xAxisMin, parosMaquina[0].inicio],
                                    itemStyle: { color: '#66bb6a', borderRadius: 4 },
                                    tipo: 'Producción',
                                    maquina: maquina.nombre
                                });
                            }

                            // Producción entre paros
                            for (var i = 0; i < parosMaquina.length - 1; i++) {
                                var finParoActual = parosMaquina[i].fin;
                                var inicioSiguienteParo = parosMaquina[i + 1].inicio;
                                if (inicioSiguienteParo > finParoActual) {
                                    dataProduccion.push({
                                        name: maquina.nombre,
                                        value: [maqIndex, finParoActual, inicioSiguienteParo],
                                        itemStyle: { color: '#66bb6a', borderRadius: 4 },
                                        tipo: 'Producción',
                                        maquina: maquina.nombre
                                    });
                                }
                            }

                            // Producción desde el último paro hasta el final
                            var ultimoParo = parosMaquina[parosMaquina.length - 1];
                            if (ultimoParo.fin < xAxisMax) {
                                dataProduccion.push({
                                    name: maquina.nombre,
                                    value: [maqIndex, ultimoParo.fin, xAxisMax],
                                    itemStyle: { color: '#66bb6a', borderRadius: 4 },
                                    tipo: 'Producción',
                                    maquina: maquina.nombre
                                });
                            }
                        }
                    });

                    // Agregar "Producción" a la leyenda al inicio
                    legendData.unshift('Producción');

                    // Construir series para cada departamento - ahora cada paro es un segmento individual
                    series = datosParos.departamentos.map(function(dept, deptIndex) {
                        var data = [];

                        // Filtrar todos los paros de este departamento
                        var parosDept = datosParos.datos.filter(function(d) {
                            return d.departamento === dept.departamento;
                        });

                        // Para cada paro, crear un segmento en el timeline
                        parosDept.forEach(function(paro) {
                            // Encontrar el índice de la máquina en el eje Y
                            var maqIndex = datosParos.maquinas.findIndex(function(m) {
                                return m.id === paro.maquinaId;
                            });

                            if (maqIndex !== -1) {
                                // Las fechas vienen en UTC desde el servidor (con 'Z')
                                // JavaScript las convierte automáticamente a hora local
                                var fechaInicio = new Date(paro.fechaInicio).getTime();
                                var fechaFin = paro.fechaFin ? new Date(paro.fechaFin).getTime() : fechaInicio;

                                // Datos: [índice Y, fecha inicio, fecha fin]
                                data.push({
                                    name: paro.maquina,
                                    value: [
                                        maqIndex,
                                        fechaInicio,
                                        fechaFin
                                    ],
                                    itemStyle: {
                                        color: dept.color || '#666666',
                                        borderRadius: 4
                                    },
                                    duracionMinutos: paro.duracionMinutos,
                                    departamento: dept.departamento,
                                    maquina: paro.maquina
                                });
                            }
                        });

                        return {
                            name: dept.departamento,
                            type: 'custom',
                            renderItem: function(params, api) {
                                var categoryIndex = api.value(0);
                                var start = api.coord([api.value(1), categoryIndex]);
                                var end = api.coord([api.value(2), categoryIndex]);
                                var height = api.size([0, 1])[1] * 0.6;

                                var rectShape = echarts.graphic.clipRectByRect({
                                    x: start[0],
                                    y: start[1] - height / 2,
                                    width: end[0] - start[0],
                                    height: height
                                }, {
                                    x: params.coordSys.x,
                                    y: params.coordSys.y,
                                    width: params.coordSys.width,
                                    height: params.coordSys.height
                                });

                                return rectShape && {
                                    type: 'rect',
                                    transition: ['shape'],
                                    shape: rectShape,
                                    style: api.style()
                                };
                            },
                            encode: {
                                x: [1, 2],
                                y: 0
                            },
                            data: data
                        };
                    });

                    // Agregar serie de producción al principio
                    series.unshift({
                        name: 'Producción',
                        type: 'custom',
                        renderItem: function(params, api) {
                            var categoryIndex = api.value(0);
                            var start = api.coord([api.value(1), categoryIndex]);
                            var end = api.coord([api.value(2), categoryIndex]);
                            var height = api.size([0, 1])[1] * 0.6;

                            var rectShape = echarts.graphic.clipRectByRect({
                                x: start[0],
                                y: start[1] - height / 2,
                                width: end[0] - start[0],
                                height: height
                            }, {
                                x: params.coordSys.x,
                                y: params.coordSys.y,
                                width: params.coordSys.width,
                                height: params.coordSys.height
                            });

                            return rectShape && {
                                type: 'rect',
                                transition: ['shape'],
                                shape: rectShape,
                                style: api.style()
                            };
                        },
                        encode: {
                            x: [1, 2],
                            y: 0
                        },
                        data: dataProduccion
                    });
                }

                // Configurar opciones de la gráfica
                var options = {
                    // Global text styles
                    textStyle: {
                        fontFamily: 'var(--body-font-family)',
                        color: 'var(--body-color)',
                        fontSize: 14,
                        lineHeight: 22,
                        textBorderColor: 'transparent'
                    },

                    // Chart animation duration
                    animationDuration: 750,

                    // Setup grid
                    grid: {
                        left: 0,
                        right: 30,
                        top: 35,
                        bottom: 0,
                        containLabel: true
                    },

                    // Add legend
                    legend: {
                        data: legendData,
                        itemHeight: 8,
                        itemGap: 30,
                        textStyle: {
                            color: 'var(--body-color)',
                            padding: [0, 5]
                        }
                    },

                    // Add tooltip
                    tooltip: {
                        trigger: 'item',
                        className: 'shadow-sm rounded',
                        backgroundColor: 'var(--white)',
                        borderColor: 'var(--gray-400)',
                        padding: 15,
                        textStyle: {
                            color: '#000'
                        },
                        formatter: function(params) {
                            if (!params || !params.value) return '';

                            var maquina = params.data.maquina;
                            var fechaInicio = new Date(params.value[1]);
                            var fechaFin = new Date(params.value[2]);
                            var duracionMs = params.value[2] - params.value[1];
                            var duracionMin = Math.round(duracionMs / 60000);

                            var result = '<strong>' + maquina + '</strong><br/>';
                            result += '<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:' + params.color + ';"></span>';

                            // Si es producción
                            if (params.data.tipo === 'Producción') {
                                result += 'Producción<br/>';
                            } else {
                                // Si es paro (tiene departamento)
                                var departamento = params.data.departamento;
                                result += departamento + '<br/>';
                            }

                            result += '<strong>Inicio:</strong> ' + fechaInicio.toLocaleString('es-MX', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: false
                            }) + '<br/>';
                            result += '<strong>Fin:</strong> ' + fechaFin.toLocaleString('es-MX', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: false
                            }) + '<br/>';
                            result += '<strong>Duración:</strong> ' + duracionMin + ' min';

                            return result;
                        }
                    },

                    // Horizontal axis (Timeline)
                    xAxis: [{
                        type: 'time',
                        min: xAxisMin,
                        max: xAxisMax,
                        axisLabel: {
                            color: 'rgba(var(--body-color-rgb), .65)',
                            formatter: function(value) {
                                var date = new Date(value);
                                var day = ('0' + date.getDate()).slice(-2);
                                var month = ('0' + (date.getMonth() + 1)).slice(-2);
                                var hours = ('0' + date.getHours()).slice(-2);
                                var minutes = ('0' + date.getMinutes()).slice(-2);
                                return day + '/' + month + '\n' + hours + ':' + minutes;
                            }
                        },
                        axisLine: {
                            show: true,
                            lineStyle: {
                                color: 'var(--gray-500)'
                            }
                        },
                        splitLine: {
                            show: true,
                            lineStyle: {
                                color: 'var(--gray-300)',
                                type: 'dashed'
                            }
                        }
                    }],

                    // Vertical axis
                    yAxis: [{
                        type: 'category',
                        data: yAxisData,
                        axisLabel: {
                            color: 'rgba(var(--body-color-rgb), .65)'
                        },
                        axisLine: {
                            lineStyle: {
                                color: 'var(--gray-500)'
                            }
                        },
                        splitLine: {
                            show: true,
                            lineStyle: {
                                color: 'var(--gray-300)'
                            }
                        },
                        splitArea: {
                            show: true,
                            areaStyle: {
                                color: ['rgba(var(--white-rgb), .01)', 'rgba(var(--black-rgb), .01)']
                            }
                        }
                    }],

                    // Add series
                    series: series
                };

                // Aplicar opciones a la gráfica
                chartInstance.setOption(options, true);
            }

            // Función para actualizar la gráfica con nuevos datos
            function updateChart(areaId, lineaId, estacionId, maquinaId) {
                var url = '/Linealytics/GetDatosParosPorDepartamento?';
                var params = [];

                if (areaId) params.push('areaId=' + areaId);
                if (lineaId) params.push('lineaId=' + lineaId);
                if (estacionId) params.push('estacionId=' + estacionId);
                if (maquinaId) params.push('maquinaId=' + maquinaId);

                url += params.join('&');

                $.ajax({
                    url: url,
                    type: 'GET',
                    success: function(data) {
                        console.log('Datos de departamentos recibidos:', data);
                        drawBarsStacked(data);
                    },
                    error: function(error) {
                        console.error('Error al cargar datos de departamentos:', error);
                    }
                });
            }

            return {
                init: function() {
                    _barsStackedLightExample();
                },
                update: function(areaId, lineaId, estacionId, maquinaId) {
                    updateChart(areaId, lineaId, estacionId, maquinaId);
                }
            }
        }();

        // Initialize ECharts
        document.addEventListener('DOMContentLoaded', function() {
            EchartsBarsStackedLight.init();
        });
    </script>
}
