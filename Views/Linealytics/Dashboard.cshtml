@{
    ViewData["Title"] = "Dashboard - Linealytics";
}

<div class="container-fluid">
    <div class="card shadow-sm mt-3">
        <div class="card-body">
            <h1 class="h3 mb-0">
                <i class="bi bi-speedometer2 me-2"></i>Dashboard - Linealytics
            </h1>
        </div>
    </div>

    <!-- Select with search -->
    <div class="card mt-3">
        <div class="card-header">
            <h5 class="mb-0">Filtros</h5>
        </div>

        <div class="card-body">
            <div class="row">
                <div class="col-lg-3">
                    <label class="form-label">Área</label>
                    <select class="form-control select" id="select-area">
                        <option value="">Todas las áreas</option>
                        @foreach (var area in (List<WebApp.Models.Area>)ViewBag.Areas)
                        {
                            <option value="@area.Id">@area.Nombre</option>
                        }
                    </select>
                </div>

                <div class="col-lg-3">
                    <label class="form-label">Línea</label>
                    <select class="form-control select" id="select-linea" disabled>
                        <option value="">Seleccione un área primero</option>
                        @foreach (var linea in (List<WebApp.Models.Linea>)ViewBag.Lineas)
                        {
                            <option value="@linea.Id" data-area="@linea.AreaId">@linea.Nombre</option>
                        }
                    </select>
                </div>

                <div class="col-lg-3">
                    <label class="form-label">Estación</label>
                    <select class="form-control select" id="select-estacion" disabled>
                        <option value="">Seleccione una línea primero</option>
                        @foreach (var estacion in (List<WebApp.Models.Estacion>)ViewBag.Estaciones)
                        {
                            <option value="@estacion.Id" data-linea="@estacion.LineaId" data-area="@estacion.Linea.AreaId">
                                @estacion.Nombre
                            </option>
                        }
                    </select>
                </div>

                <div class="col-lg-3">
                    <label class="form-label">Máquina</label>
                    <select class="form-control select" id="select-maquina" disabled>
                        <option value="">Seleccione una estación primero</option>
                        @foreach (var maquina in (List<WebApp.Models.Maquina>)ViewBag.Maquinas)
                        {
                            <option value="@maquina.Id" data-estacion="@maquina.EstacionId" data-linea="@maquina.Estacion.LineaId" data-area="@maquina.Estacion.Linea.AreaId">
                                @maquina.Nombre
                            </option>
                        }
                    </select>
                </div>
            </div>
        </div>
    </div>
    <!-- /select with search -->


    <!-- ECharts Stacked bar chart -->
    <div class="card mt-3">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-bar-chart-horizontal me-2"></i>Paros por Máquina y Departamento (Últimos 7 días)
            </h5>
        </div>

        <div class="card-body">
            <p class="mb-3">Gráfica de barras horizontales apiladas que muestra la duración total de paros (en minutos) por máquina durante los últimos 7 días. Cada barra representa una máquina y los segmentos de color representan los diferentes departamentos operadores responsables de los paros.</p>
            <div class="chart-container">
                <div class="chart has-fixed-height" id="bars_stacked"></div>
            </div>
        </div>
    </div>
    <!-- /stacked bar chart -->

</div>

@section Scripts {
        <script src="~/assets/js/jquery/jquery.min.js"></script>
    <script src="~/assets/js/vendor/visualization/echarts/echarts.min.js"></script>
    <script src="~/assets/js/vendor/forms/selects/select2.min.js"></script>


    <script>

        // Select2 Initialization
        // ------------------------------
        var Select2Filters = function() {

            // Guardar todas las opciones originales
            var todasLineas = [];
            var todasEstaciones = [];
            var todasMaquinas = [];

            var _componentSelect2 = function() {
                if (!$().select2) {
                    console.warn('Warning - select2.min.js is not loaded.');
                    return;
                }

                // Guardar todas las opciones al inicio
                $('#select-linea option').each(function() {
                    if ($(this).val() !== '') {
                        todasLineas.push({
                            value: $(this).val(),
                            text: $(this).text(),
                            area: $(this).data('area')
                        });
                    }
                });

                $('#select-estacion option').each(function() {
                    if ($(this).val() !== '') {
                        todasEstaciones.push({
                            value: $(this).val(),
                            text: $(this).text(),
                            linea: $(this).data('linea'),
                            area: $(this).data('area')
                        });
                    }
                });

                $('#select-maquina option').each(function() {
                    if ($(this).val() !== '') {
                        todasMaquinas.push({
                            value: $(this).val(),
                            text: $(this).text(),
                            estacion: $(this).data('estacion'),
                            linea: $(this).data('linea'),
                            area: $(this).data('area')
                        });
                    }
                });

                // Initialize all selects with Select2
                $('.select').select2({
                    placeholder: 'Seleccionar...',
                    allowClear: true
                });

                // Filtros en cascada
                $('#select-area').on('change', function() {
                    var areaId = $(this).val();

                    if (!areaId) {
                        // Si no hay área seleccionada, deshabilitar líneas, estaciones y máquinas
                        $('#select-linea').prop('disabled', true);
                        $('#select-estacion').prop('disabled', true);
                        $('#select-maquina').prop('disabled', true);

                        $('#select-linea').empty().append('<option value="">Seleccione un área primero</option>');
                        $('#select-estacion').empty().append('<option value="">Seleccione un área primero</option>');
                        $('#select-maquina').empty().append('<option value="">Seleccione un área primero</option>');

                        $('#select-linea').val('').trigger('change');
                        $('#select-estacion').val('').trigger('change');
                        $('#select-maquina').val('').trigger('change');
                    } else {
                        // Habilitar select de líneas
                        $('#select-linea').prop('disabled', false);

                        // Filtrar y reconstruir líneas
                        $('#select-linea').empty().append('<option value="">Todas las líneas</option>');

                        todasLineas.filter(function(linea) {
                            return linea.area == areaId;
                        }).forEach(function(linea) {
                            $('#select-linea').append(
                                $('<option></option>')
                                    .attr('value', linea.value)
                                    .attr('data-area', linea.area)
                                    .text(linea.text)
                            );
                        });

                        // Filtrar y reconstruir estaciones por área
                        $('#select-estacion').empty().append('<option value="">Todas las estaciones</option>');

                        todasEstaciones.filter(function(estacion) {
                            return estacion.area == areaId;
                        }).forEach(function(estacion) {
                            $('#select-estacion').append(
                                $('<option></option>')
                                    .attr('value', estacion.value)
                                    .attr('data-linea', estacion.linea)
                                    .attr('data-area', estacion.area)
                                    .text(estacion.text)
                            );
                        });

                        // Habilitar select de estaciones
                        $('#select-estacion').prop('disabled', false);

                        // Filtrar y reconstruir máquinas por área
                        $('#select-maquina').empty().append('<option value="">Todas las máquinas</option>');

                        todasMaquinas.filter(function(maquina) {
                            return maquina.area == areaId;
                        }).forEach(function(maquina) {
                            $('#select-maquina').append(
                                $('<option></option>')
                                    .attr('value', maquina.value)
                                    .attr('data-estacion', maquina.estacion)
                                    .attr('data-linea', maquina.linea)
                                    .attr('data-area', maquina.area)
                                    .text(maquina.text)
                            );
                        });

                        // Habilitar select de máquinas
                        $('#select-maquina').prop('disabled', false);

                        // Reset selects dependientes
                        $('#select-linea').val('').trigger('change');
                        $('#select-estacion').val('').trigger('change');
                        $('#select-maquina').val('').trigger('change');
                    }
                });

                $('#select-linea').on('change', function() {
                    var lineaId = $(this).val();
                    var areaId = $('#select-area').val();

                    // Filtrar y reconstruir estaciones
                    $('#select-estacion').empty().append('<option value="">Todas las estaciones</option>');

                    var estacionesFiltradas = todasEstaciones;

                    // Filtrar por área si está seleccionada
                    if (areaId) {
                        estacionesFiltradas = estacionesFiltradas.filter(function(estacion) {
                            return estacion.area == areaId;
                        });
                    }

                    // Filtrar por línea si está seleccionada
                    if (lineaId) {
                        estacionesFiltradas = estacionesFiltradas.filter(function(estacion) {
                            return estacion.linea == lineaId;
                        });
                    }

                    // Agregar opciones filtradas de estaciones
                    estacionesFiltradas.forEach(function(estacion) {
                        $('#select-estacion').append(
                            $('<option></option>')
                                .attr('value', estacion.value)
                                .attr('data-linea', estacion.linea)
                                .attr('data-area', estacion.area)
                                .text(estacion.text)
                        );
                    });

                    // Filtrar y reconstruir máquinas
                    $('#select-maquina').empty().append('<option value="">Todas las máquinas</option>');

                    var maquinasFiltradas = todasMaquinas;

                    // Filtrar por área si está seleccionada
                    if (areaId) {
                        maquinasFiltradas = maquinasFiltradas.filter(function(maquina) {
                            return maquina.area == areaId;
                        });
                    }

                    // Filtrar por línea si está seleccionada
                    if (lineaId) {
                        maquinasFiltradas = maquinasFiltradas.filter(function(maquina) {
                            return maquina.linea == lineaId;
                        });
                    }

                    // Agregar opciones filtradas de máquinas
                    maquinasFiltradas.forEach(function(maquina) {
                        $('#select-maquina').append(
                            $('<option></option>')
                                .attr('value', maquina.value)
                                .attr('data-estacion', maquina.estacion)
                                .attr('data-linea', maquina.linea)
                                .attr('data-area', maquina.area)
                                .text(maquina.text)
                        );
                    });

                    // Reset selects de estaciones y máquinas
                    $('#select-estacion').val('').trigger('change');
                    $('#select-maquina').val('').trigger('change');
                });

                $('#select-estacion').on('change', function() {
                    var estacionId = $(this).val();
                    var lineaId = $('#select-linea').val();
                    var areaId = $('#select-area').val();

                    // Filtrar y reconstruir máquinas
                    $('#select-maquina').empty().append('<option value="">Todas las máquinas</option>');

                    var maquinasFiltradas = todasMaquinas;

                    // Filtrar por área si está seleccionada
                    if (areaId) {
                        maquinasFiltradas = maquinasFiltradas.filter(function(maquina) {
                            return maquina.area == areaId;
                        });
                    }

                    // Filtrar por línea si está seleccionada
                    if (lineaId) {
                        maquinasFiltradas = maquinasFiltradas.filter(function(maquina) {
                            return maquina.linea == lineaId;
                        });
                    }

                    // Filtrar por estación si está seleccionada
                    if (estacionId) {
                        maquinasFiltradas = maquinasFiltradas.filter(function(maquina) {
                            return maquina.estacion == estacionId;
                        });
                    }

                    // Agregar opciones filtradas
                    maquinasFiltradas.forEach(function(maquina) {
                        $('#select-maquina').append(
                            $('<option></option>')
                                .attr('value', maquina.value)
                                .attr('data-estacion', maquina.estacion)
                                .attr('data-linea', maquina.linea)
                                .attr('data-area', maquina.area)
                                .text(maquina.text)
                        );
                    });

                    // Reset select de máquinas
                    $('#select-maquina').val('').trigger('change');
                });

                // Evento cuando cambia cualquier filtro - actualizar gráfica
                $('.select').on('change', function() {
                    var areaId = $('#select-area').val();
                    var lineaId = $('#select-linea').val();
                    var estacionId = $('#select-estacion').val();
                    var maquinaId = $('#select-maquina').val();

                    console.log('Filtro cambiado:', {
                        area: areaId,
                        linea: lineaId,
                        estacion: estacionId,
                        maquina: maquinaId
                    });

                    // Si hay área seleccionada, actualizar la gráfica
                    if (areaId) {
                        EchartsBarsStackedLight.update(areaId, lineaId || null, estacionId || null, maquinaId || null);
                    }
                });
            };

            return {
                init: function() {
                    _componentSelect2();
                }
            }
        }();

        // Initialize Select2
        document.addEventListener('DOMContentLoaded', function() {
            Select2Filters.init();
        });

        // ECharts Stacked Bars
        // ------------------------------
        var EchartsBarsStackedLight = function() {

            var chartInstance = null;

            // Stacked bar chart
            var _barsStackedLightExample = function() {
                if (typeof echarts == 'undefined') {
                    console.warn('Warning - echarts.min.js is not loaded.');
                    return;
                }

                // Define element
                var bars_stacked_element = document.getElementById('bars_stacked');

                // Charts configuration
                if (bars_stacked_element) {

                    // Initialize chart
                    var bars_stacked = echarts.init(bars_stacked_element, null, { renderer: 'svg' });
                    chartInstance = bars_stacked;

                    // Draw chart with empty data
                    drawBarsStacked(null);

                    // Resize handlers
                    var triggerChartResize = function() {
                        bars_stacked_element && bars_stacked.resize();
                    };

                    // On sidebar width change
                    var sidebarToggle = document.querySelectorAll('.sidebar-control');
                    if (sidebarToggle) {
                        sidebarToggle.forEach(function(togglers) {
                            togglers.addEventListener('click', triggerChartResize);
                        });
                    }

                    // On window resize
                    var resizeCharts;
                    window.addEventListener('resize', function() {
                        clearTimeout(resizeCharts);
                        resizeCharts = setTimeout(function () {
                            triggerChartResize();
                        }, 200);
                    });
                }
            };

            // Chart settings
            function drawBarsStacked(datosParos) {
                if (!chartInstance) return;

                var legendData = [];
                var yAxisData = [];
                var series = [];
                var xAxisMin = null;
                var xAxisMax = null;

                if (!datosParos || !datosParos.maquinas || datosParos.maquinas.length === 0) {
                    // Datos de ejemplo si no hay datos
                    legendData = ['Sin datos'];
                    yAxisData = ['Selecciona un área'];
                    series = [{
                        name: 'Sin datos',
                        type: 'bar',
                        stack: 'Total',
                        barWidth: 36,
                        itemStyle: {
                            color: '#ccc',
                            barBorderRadius: [0, 4, 4, 0]
                        },
                        data: [[0, 0, 0]]
                    }];
                } else {
                    console.log('Datos recibidos:', datosParos);
                    console.log('Maquinas:', datosParos.maquinas);
                    console.log('Departamentos:', datosParos.departamentos);
                    console.log('Datos paros:', datosParos.datos);

                    // Construir leyenda con departamentos (minúsculas por JSON camelCase)
                    legendData = datosParos.departamentos.map(function(d) {
                        return d.departamento;
                    });
                    console.log('Legend data:', legendData);

                    // Usar las máquinas como eje Y (minúsculas por JSON camelCase)
                    yAxisData = datosParos.maquinas.map(function(m) {
                        return m.nombre;
                    });
                    console.log('Y-axis data (maquinas):', yAxisData);

                    // Configurar rango de fechas para el eje X
                    xAxisMin = new Date(datosParos.fechaMin).getTime();
                    xAxisMax = new Date(datosParos.fechaMax).getTime();

                    // Construir series para cada departamento
                    series = datosParos.departamentos.map(function(dept, deptIndex) {
                        // Para cada máquina, obtener todos los paros de este departamento
                        var data = [];

                        datosParos.maquinas.forEach(function(maquina, maqIndex) {
                            console.log('Procesando maquina:', maquina.nombre, 'ID:', maquina.id, 'para departamento:', dept.departamento);

                            // Filtrar paros de esta máquina y departamento
                            var parosMaquina = datosParos.datos.filter(function(d) {
                                return d.maquinaId === maquina.id && d.departamento === dept.departamento;
                            });
                            console.log('Paros encontrados:', parosMaquina.length, parosMaquina);

                            // Acumular duración total por máquina y departamento
                            var totalMinutos = 0;
                            parosMaquina.forEach(function(paro) {
                                totalMinutos += paro.duracionMinutos;
                            });
                            console.log('Total minutos para', maquina.nombre, '-', dept.departamento, ':', totalMinutos);

                            // Agregar dato para todas las máquinas (incluir 0 para mantener estructura)
                            data.push(totalMinutos);
                        });

                        console.log('Data array para departamento', dept.departamento, ':', data);

                        // Determinar si es el último departamento para aplicar bordes redondeados
                        var isLast = deptIndex === datosParos.departamentos.length - 1;

                        return {
                            name: dept.departamento,
                            type: 'bar',
                            stack: 'Total',
                            barWidth: 36,
                            itemStyle: {
                                color: dept.color || '#666666',
                                barBorderRadius: isLast ? [0, 4, 4, 0] : [0, 0, 0, 0]
                            },
                            label: {
                                show: true,
                                position: 'insideRight',
                                fontSize: 12,
                                fontWeight: 500,
                                formatter: function(params) {
                                    return params.value > 0 ? params.value + ' min' : '';
                                }
                            },
                            data: data
                        };
                    });
                }

                // Configurar opciones de la gráfica
                var options = {
                    // Global text styles
                    textStyle: {
                        fontFamily: 'var(--body-font-family)',
                        color: 'var(--body-color)',
                        fontSize: 14,
                        lineHeight: 22,
                        textBorderColor: 'transparent'
                    },

                    // Chart animation duration
                    animationDuration: 750,

                    // Setup grid
                    grid: {
                        left: 0,
                        right: 30,
                        top: 35,
                        bottom: 0,
                        containLabel: true
                    },

                    // Add legend
                    legend: {
                        data: legendData,
                        itemHeight: 8,
                        itemGap: 30,
                        textStyle: {
                            color: 'var(--body-color)',
                            padding: [0, 5]
                        }
                    },

                    // Add tooltip
                    tooltip: {
                        trigger: 'axis',
                        className: 'shadow-sm rounded',
                        backgroundColor: 'var(--white)',
                        borderColor: 'var(--gray-400)',
                        padding: 15,
                        textStyle: {
                            color: '#000'
                        },
                        axisPointer: {
                            type: 'shadow',
                            shadowStyle: {
                                color: 'rgba(var(--body-color-rgb), 0.025)'
                            }
                        },
                        formatter: function(params) {
                            if (!params || params.length === 0) return '';

                            var maquinaNombre = yAxisData[params[0].value[0]] || 'Desconocido';
                            var result = '<strong>' + maquinaNombre + '</strong><br/>';
                            var total = 0;

                            params.forEach(function(item) {
                                if (item.value && item.value[1] > 0) {
                                    result += '<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:' + item.color + ';"></span>';
                                    result += item.seriesName + ': ' + item.value[1] + ' min<br/>';
                                    total += item.value[1];
                                }
                            });
                            result += '<strong>Total: ' + total + ' min</strong>';
                            return result;
                        }
                    },

                    // Horizontal axis
                    xAxis: [{
                        type: 'value',
                        axisLabel: {
                            color: 'rgba(var(--body-color-rgb), .65)',
                            formatter: '{value} min'
                        },
                        axisLine: {
                            show: true,
                            lineStyle: {
                                color: 'var(--gray-500)'
                            }
                        },
                        splitLine: {
                            show: true,
                            lineStyle: {
                                color: 'var(--gray-300)',
                                type: 'dashed'
                            }
                        }
                    }],

                    // Vertical axis
                    yAxis: [{
                        type: 'category',
                        data: yAxisData,
                        axisLabel: {
                            color: 'rgba(var(--body-color-rgb), .65)'
                        },
                        axisLine: {
                            lineStyle: {
                                color: 'var(--gray-500)'
                            }
                        },
                        splitLine: {
                            show: true,
                            lineStyle: {
                                color: 'var(--gray-300)'
                            }
                        },
                        splitArea: {
                            show: true,
                            areaStyle: {
                                color: ['rgba(var(--white-rgb), .01)', 'rgba(var(--black-rgb), .01)']
                            }
                        }
                    }],

                    // Add series
                    series: series
                };

                // Aplicar opciones a la gráfica
                chartInstance.setOption(options, true);
            }

            // Función para actualizar la gráfica con nuevos datos
            function updateChart(areaId, lineaId, estacionId, maquinaId) {
                var url = '/Linealytics/GetDatosParosPorDepartamento?';
                var params = [];

                if (areaId) params.push('areaId=' + areaId);
                if (lineaId) params.push('lineaId=' + lineaId);
                if (estacionId) params.push('estacionId=' + estacionId);
                if (maquinaId) params.push('maquinaId=' + maquinaId);

                url += params.join('&');

                $.ajax({
                    url: url,
                    type: 'GET',
                    success: function(data) {
                        console.log('Datos de departamentos recibidos:', data);
                        drawBarsStacked(data);
                    },
                    error: function(error) {
                        console.error('Error al cargar datos de departamentos:', error);
                    }
                });
            }

            return {
                init: function() {
                    _barsStackedLightExample();
                },
                update: function(areaId, lineaId, estacionId, maquinaId) {
                    updateChart(areaId, lineaId, estacionId, maquinaId);
                }
            }
        }();

        // Initialize ECharts
        document.addEventListener('DOMContentLoaded', function() {
            EchartsBarsStackedLight.init();
        });
    </script>
}
